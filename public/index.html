<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GuaraniToken ‚Ä¢ Local Bridge Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Ethers v6 (UMD)  ‚Üí no CORS issues -->
  <script src="https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #6200ee;
      --primary-dark: #3700b3;
      --bg: #fafafa;
      --surface: #fff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Roboto, sans-serif; background: var(--bg); color:#222;
      display:flex; flex-direction:column; align-items:center;
    }
    h1 { font-size:1.7rem; font-weight:400; margin:1.3rem 0 .5rem; color:var(--primary); }
    .card {
      width:100%; max-width:420px; background:var(--surface); border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.08); padding:24px; margin:1rem;
    }
    label { display:block; font-size:.85rem; margin-bottom:4px; opacity:.8; }
    input {
      width:100%; padding:10px 14px; border:1px solid #ccc; border-radius:4px;
      font-size:.95rem; margin-bottom:16px; transition:border-color .2s;
    }
    input:focus { outline:none; border-color:var(--primary); }
    button {
      display:block; width:100%; background:var(--primary); color:#fff;
      border:none; border-radius:4px; padding:12px; font-size:.9rem;letter-spacing:.5px;
      cursor:pointer; transition:background .2s,box-shadow .2s;
    }
    button:hover { background:var(--primary-dark); box-shadow:0 4px 10px rgba(0,0,0,.18); }
    pre { background:#111; color:#0f0; border-radius:4px; padding:12px; height:160px; overflow:auto; white-space:pre-wrap; font-family:monospace; font-size:.77rem; margin-top:20px; }
    
    /* Estilos para las tablas de monitoreo */
    .monitor-section { margin-top: 2rem; }
    .monitor-tables { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; }
    .table-container { flex: 1; min-width: 600px; max-width: 800px; }
    .table-title { text-align: center; font-size: 1.1rem; font-weight: 500; color: var(--primary); margin-bottom: 0.5rem; }
    .balance-table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.08); table-layout: fixed; }
    .balance-table th, .balance-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #eee; word-wrap: break-word; }
    .balance-table th:first-child, .balance-table td:first-child { width: 60%; }
    .balance-table th:nth-child(2), .balance-table td:nth-child(2) { width: 20%; }
    .balance-table th:nth-child(3), .balance-table td:nth-child(3) { width: 20%; }
    .balance-table th { background: #f5f5f5; font-weight: 500; font-size: 0.85rem; }
    .balance-table td { font-size: 0.8rem; }
    .balance-table tr:hover { background: #f9f9f9; }
    .address { color: #666; }
    .balance { font-weight: bold; color: var(--primary); }
    .contract-info { background: var(--surface); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    .contract-info h3 { margin: 0 0 0.5rem; color: var(--primary); font-size: 1rem; }
    .contract-address { font-family: monospace; font-size: 0.85rem; color: #666; word-break: break-all; }
    .refresh-btn { background: #28a745; padding: 6px 12px; border-radius: 4px; border: none; color: white; font-size: 0.8rem; cursor: pointer; margin-bottom: 1rem; }
    .refresh-btn:hover { background: #218838; }
  </style>
</head>
<body>
  <h1>GuaraniToken Bridge (Local)</h1>
  <div class="card">
    <label for="dest">Destino (L2 address)</label>
    <input id="dest" placeholder="0x‚Ä¶" />

    <label for="amt">Monto (GUA)</label>
    <input id="amt" type="number" value="10" step="0.0001" />

    <button id="btn-bridge">BRIDGE ‚Üí</button>

    <pre id="log"></pre>
  </div>

  <!-- Secci√≥n de Monitoreo de Balances -->
  <div class="monitor-section">
    <h2 style="text-align: center; color: var(--primary); margin-bottom: 1rem;">üîç Monitor de Balances</h2>
    
    <!-- Informaci√≥n de Contratos -->
    <div class="monitor-tables">
      <div class="table-container">
        <div class="contract-info">
          <h3>üìã Contratos L1 (Hardhat - 31337)</h3>
          <div>Token: <span class="contract-address" id="l1-token-addr">0x5FbDB2315678afecb367f032d93F642f64180aa3</span></div>
          <div>Sender: <span class="contract-address" id="l1-sender-addr">0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512</span></div>
        </div>
      </div>
      <div class="table-container">
        <div class="contract-info">
          <h3>üìã Contratos L2 (Anvil - 1338)</h3>
          <div>Token: <span class="contract-address" id="l2-token-addr">0x8464135c8F25Da09e49BC8782676a84730C318bC</span></div>
          <div>Receiver: <span class="contract-address" id="l2-receiver-addr">0x71C95911E9a5D330f4D621842EC243EE1343292e</span></div>
        </div>
      </div>
    </div>

    <!-- Tablas de Balances -->
    <div class="monitor-tables">
      <div class="table-container">
        <div class="table-title">üåê L1 - Hardhat (Chain ID: 31337)</div>
        <button class="refresh-btn" onclick="updateAllBalances()">üîÑ Actualizar</button>
        <table class="balance-table">
          <thead>
            <tr>
              <th>Direcci√≥n de Cuenta</th>
              <th>ETH</th>
              <th>Balance GUA</th>
            </tr>
          </thead>
          <tbody id="l1-balances">
            <tr><td colspan="3">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="table-container">
        <div class="table-title">‚õìÔ∏è L2 - Anvil (Chain ID: 1338)</div>
        <button class="refresh-btn" onclick="updateAllBalances()">üîÑ Actualizar</button>
        <table class="balance-table">
          <thead>
            <tr>
              <th>Direcci√≥n de Cuenta</th>
              <th>ETH</th>
              <th>Balance GUA</th>
            </tr>
          </thead>
          <tbody id="l2-balances">
            <tr><td colspan="3">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(async () => {
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Config   (rellena tras tu deploy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CHAIN_L1 = "0x7a69";   // 31337
  const SENDER_L1 = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if (!window.ethereum) return alert("Instala MetaMask");

  const log = (m) => {
    const el = document.getElementById("log");
    el.textContent += m + "\n"; el.scrollTop = el.scrollHeight;
  };

  /* auto-connect with error handling */
  let provider, signer;
  try {
    // Check if already connected first
    const accounts = await ethereum.request({ method: "eth_accounts" });
    
    if (accounts.length === 0) {
      // Only request accounts if not already connected
      await ethereum.request({ method: "eth_requestAccounts" });
    }
    
    provider = new ethers.BrowserProvider(ethereum);
    signer = await provider.getSigner();
    const { chainId } = await provider.getNetwork();
    log(`Connected ${signer.address}  (chainId ${chainId})`);
  } catch (error) {
    if (error.code === -32002) {
      log("‚ö†Ô∏è MetaMask request already pending. Please check MetaMask and try refreshing the page.");
      console.error("MetaMask permission request pending:", error);
      return;
    } else {
      log(`‚ùå Connection error: ${error.message}`);
      console.error("Connection error:", error);
      return;
    }
  }

    /* switch helper */
  const switchTo = async (hexId) => {
    const want = BigInt(parseInt(hexId, 16));     // 31337n
    const now  = (await provider.getNetwork()).chainId; // BigInt
    if (now !== want) {
      try { 
        await ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:hexId }] }); 
      } catch (e) { 
        if (e.code === -32002) {
          log("‚ö†Ô∏è MetaMask request already pending. Please check MetaMask.");
        } else {
          log("‚ö†Ô∏è switch chain rejected"); 
        }
        throw e; 
      }
    }
  };

  const abiToken  = [
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "initialSupply",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [],
      "name": "AccessControlBadConfirmation",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "account",
          "type": "address"
        },
        {
          "internalType": "bytes32",
          "name": "neededRole",
          "type": "bytes32"
        }
      ],
      "name": "AccessControlUnauthorizedAccount",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "spender",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "allowance",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "needed",
          "type": "uint256"
        }
      ],
      "name": "ERC20InsufficientAllowance",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "sender",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "balance",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "needed",
          "type": "uint256"
        }
      ],
      "name": "ERC20InsufficientBalance",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "approver",
          "type": "address"
        }
      ],
      "name": "ERC20InvalidApprover",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "receiver",
          "type": "address"
        }
      ],
      "name": "ERC20InvalidReceiver",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "sender",
          "type": "address"
        }
      ],
      "name": "ERC20InvalidSender",
      "type": "error"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "spender",
          "type": "address"
        }
      ],
      "name": "ERC20InvalidSpender",
      "type": "error"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "spender",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "value",
          "type": "uint256"
        }
      ],
      "name": "Approval",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "indexed": true,
          "internalType": "bytes32",
          "name": "previousAdminRole",
          "type": "bytes32"
        },
        {
          "indexed": true,
          "internalType": "bytes32",
          "name": "newAdminRole",
          "type": "bytes32"
        }
      ],
      "name": "RoleAdminChanged",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "account",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "sender",
          "type": "address"
        }
      ],
      "name": "RoleGranted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "account",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "sender",
          "type": "address"
        }
      ],
      "name": "RoleRevoked",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "from",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "value",
          "type": "uint256"
        }
      ],
      "name": "Transfer",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "DEFAULT_ADMIN_ROLE",
      "outputs": [
        {
          "internalType": "bytes32",
          "name": "",
          "type": "bytes32"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "MINTER_ROLE",
      "outputs": [
        {
          "internalType": "bytes32",
          "name": "",
          "type": "bytes32"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "spender",
          "type": "address"
        }
      ],
      "name": "allowance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "spender",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "value",
          "type": "uint256"
        }
      ],
      "name": "approve",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "account",
          "type": "address"
        }
      ],
      "name": "balanceOf",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "decimals",
      "outputs": [
        {
          "internalType": "uint8",
          "name": "",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        }
      ],
      "name": "getRoleAdmin",
      "outputs": [
        {
          "internalType": "bytes32",
          "name": "",
          "type": "bytes32"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "internalType": "address",
          "name": "account",
          "type": "address"
        }
      ],
      "name": "grantRole",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "internalType": "address",
          "name": "account",
          "type": "address"
        }
      ],
      "name": "hasRole",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "mint",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "name",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "internalType": "address",
          "name": "callerConfirmation",
          "type": "address"
        }
      ],
      "name": "renounceRole",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes32",
          "name": "role",
          "type": "bytes32"
        },
        {
          "internalType": "address",
          "name": "account",
          "type": "address"
        }
      ],
      "name": "revokeRole",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes4",
          "name": "interfaceId",
          "type": "bytes4"
        }
      ],
      "name": "supportsInterface",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "symbol",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "totalSupply",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "value",
          "type": "uint256"
        }
      ],
      "name": "transfer",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "from",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "value",
          "type": "uint256"
        }
      ],
      "name": "transferFrom",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
  const abiSender = [
    {
      "inputs": [
        {
          "internalType": "contract GuaraniToken",
          "name": "_token",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "from",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Locked",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "recipientL2",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "lock",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "lockedBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "nonce",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "token",
      "outputs": [
        {
          "internalType": "contract GuaraniToken",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ];

  const token  = new ethers.Contract("0x5FbDB2315678afecb367f032d93F642f64180aa3" , abiToken , signer);
  const sender = new ethers.Contract(SENDER_L1, abiSender, signer);

  document.getElementById("btn-bridge").onclick = async () => {
    debugger;
    try {
      console.log('escuchando');
      await switchTo(CHAIN_L1);

      const dest   = document.getElementById("dest").value.trim();
      const amount = ethers.parseUnits(document.getElementById("amt").value || "0", 18);
      if (!ethers.isAddress(dest)) return alert("Direcci√≥n destino inv√°lida");

      /* approve if needed */
      const allow = await token.allowance(signer.address, SENDER_L1);
      if (allow < amount) {
        log("approve‚Ä¶");
        const tx = await token.approve(SENDER_L1, amount);
        await tx.wait(); log("approve ok");
      }

      /* lock */
      log("lock‚Ä¶");
      const tx2 = await sender.lock(dest, amount);
      await tx2.wait();
      const idBN   = await sender.nonce();
      const lockId = idBN - 1n; // BigInt math OK
      log(`‚úÖ Locked id ${lockId.toString()}, amount ${ethers.formatUnits(amount,18)} GUA`);
      log("üîÑ Espera que el relayer acu√±e en L2‚Ä¶");

    } catch (e) {
      console.error("Bridge error:", e);
      
      let errorMsg = "Error desconocido";
      
      if (e.message?.includes("nonce")) {
        errorMsg = "Error de nonce. Por favor intenta nuevamente.";
      } else if (e.message?.includes("insufficient funds")) {
        errorMsg = "Fondos insuficientes";
      } else if (e.message?.includes("allowance")) {
        errorMsg = "Error de allowance";
      } else if (e.code === "ACTION_REJECTED") {
        errorMsg = "Transacci√≥n rechazada por el usuario";
      } else if (e.message?.includes("Internal JSON-RPC error")) {
        errorMsg = "Error interno del nodo. Verifica que tengas tokens suficientes.";
      } else {
        errorMsg = e?.info?.error?.message || e.shortMessage || e.message;
      }
      
      log("‚ùå " + errorMsg);
    }
  };
  // Escuchar el evento Minted del contrato en L2
  // ABI del evento Minted (ajusta los par√°metros seg√∫n tu contrato)
  const abiMinted = [
    {
      "inputs": [
        {
          "internalType": "contract GuaraniToken",
          "name": "_token",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "_relayer",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Minted",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "mintRemote",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "processed",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "relayer",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "token",
      "outputs": [
        {
          "internalType": "contract GuaraniToken",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ];
  // Contract addresses and providers setup
  const TOKEN_L1 = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // Token contract L1
  const CONTRACT_L1 = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"; // Sender contract address
  const TOKEN_L2 = "0x8464135c8F25Da09e49BC8782676a84730C318bC"; // Token contract L2  
  const CONTRACT_L2 = "0x71C95911E9a5D330f4D621842EC243EE1343292e"; // Receiver contract address

  // Note: Browser always connects to localhost (mapped ports from docker-compose)
  // Docker containers expose ports: hardhat-n1:8545->8545, anvil-n2:9545->9545
  const providerL1 = new ethers.JsonRpcProvider("http://localhost:8545"); // L1 Hardhat port
  const providerL2 = new ethers.JsonRpcProvider("http://localhost:9545"); // L2 Anvil port

  // Create token contracts for balance queries
  const tokenL1 = new ethers.Contract(TOKEN_L1, abiToken, providerL1);
  const tokenL2 = new ethers.Contract(TOKEN_L2, abiToken, providerL2);
  
  // Create bridge contracts for events  
  const contractL1 = new ethers.Contract(CONTRACT_L1, abiSender, providerL1);
  const contractL2 = new ethers.Contract(CONTRACT_L2, abiMinted, providerL2);

  contractL2.on("Minted", (to, amount, lockId, event) => {
    log(`üéâ Minted: to=${to}, amount=${ethers.formatUnits(amount,18)} GUA, lockId=${lockId}`);
  });

  // Balance Monitoring System
  const accounts = [
    "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
    "0x70997970C51812dc3A010C7d01b50e0d17dc79C8", 
    "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
    "0x90F79bf6EB2c4f870365E785982E1f101E93b906",
    "0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65",
    "0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc",
    "0x976EA74026E726554dB657fA54763abd0C3a0aa9",
    "0x14dC79964da2C08b23698B3D3cc7Ca32193d9955",
    "0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f",
    "0xa0Ee7A142d267C1f36714E4a8F75612F20a79720"
  ];

  async function updateBalanceTable(networkId, provider, tokenContract, accountsList) {
    const tableBody = document.getElementById(`${networkId}-balances`);
    if (!tableBody) {
      console.error(`Table body not found for ${networkId}-balances`);
      return;
    }
    
    tableBody.innerHTML = '';
    
    for (const account of accountsList) {
      try {
        // Test if we can connect to the provider first
        await provider.getBlockNumber();
        
        // Get ETH balance
        const ethBalance = await provider.getBalance(account);
        const ethBalanceFormatted = parseFloat(ethers.formatEther(ethBalance)).toFixed(4);
        
        // Get GUA token balance
        const tokenBalance = await tokenContract.balanceOf(account);
        const guaBalanceFormatted = parseFloat(ethers.formatUnits(tokenBalance, 18)).toFixed(2);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-family: monospace; font-size: 12px;">${account}</td>
          <td>${ethBalanceFormatted} ETH</td>
          <td>${guaBalanceFormatted} GUA</td>
        `;
        tableBody.appendChild(row);
      } catch (error) {
        console.error(`Error fetching balance for ${account}:`, error);
        let errorMsg = "Error";
        
        if (error.message.includes("could not decode result data")) {
          errorMsg = "Contract not found";
        } else if (error.message.includes("network")) {
          errorMsg = "Network error";
        } else if (error.code === 'NETWORK_ERROR') {
          errorMsg = "RPC error";
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-family: monospace; font-size: 12px;">${account}</td>
          <td>${errorMsg}</td>
          <td>${errorMsg}</td>
        `;
        tableBody.appendChild(row);
      }
    }
  }

  async function updateAllBalances() {
    try {
      console.log('Updating L1 balances...');
      console.log('L1 Provider URL:', providerL1._getConnection().url);
      console.log('L1 Token Address:', TOKEN_L1);
      
      await updateBalanceTable('l1', providerL1, tokenL1, accounts);
      
      console.log('Updating L2 balances...');
      console.log('L2 Provider URL:', providerL2._getConnection().url);
      console.log('L2 Token Address:', TOKEN_L2);
      
      await updateBalanceTable('l2', providerL2, tokenL2, accounts);
      
      // Update contract addresses display
      const l1ContractElement = document.getElementById('l1-contract-address');
      const l2ContractElement = document.getElementById('l2-contract-address');
      if (l1ContractElement) l1ContractElement.textContent = TOKEN_L1;
      if (l2ContractElement) l2ContractElement.textContent = TOKEN_L2;
      
      console.log('Balance update completed');
    } catch (error) {
      console.error('Error updating balances:', error);
      // Show user-friendly error message
      if (error.code === -32002) {
        log("‚ö†Ô∏è MetaMask request pending. Please complete the pending request and try again.");
      } else {
        log(`‚ùå Error updating balances: ${error.message}`);
      }
    }
  }

  // Auto-refresh balances every 10 seconds
  setInterval(updateAllBalances, 10000);
  
  // Initial balance load
  updateAllBalances();
  
})();
</script>
</body>
</html>